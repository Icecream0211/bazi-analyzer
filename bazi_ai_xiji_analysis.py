from ai_models.glm4 import GLM4Model
from bazi_need import get_bazi_need
import json

glm4_model = GLM4Model("c071cdc6b53eb53e1cd1cd6ad0a5e4db.fEV7OrCxYmiqazjd")


## 喜忌分析
def bazi_xiji_ai_analysis(result):

    prompt1 = f"""
    基于以下八字信息进行分析：
    {json.dumps(result, ensure_ascii=False)}
    """

    prompt = prompt1 + """
    你是一位资深的八字命理专家
    请你基于这些信息，进行详细的五行喜忌分析，并按以下步骤生成内容：

    ### 一、五行喜忌分析
    1. **喜用神和忌用神**：根据用户八字，指出最重要的喜用神和忌用神，并解释这些神在八字中的作用。
    2. **流年影响**：分析未来三年内流年对用户喜用神的影响，重点描述运势的起伏变化。
    3. **幸运颜色和方位**：根据用户八字中的喜用神，提供适合用户的幸运颜色和方位，并说明如何利用这些元素提升运势。

    ### 二、五行影响力评分
    根据用户的八字、大运喜忌及调候喜忌，分析五行（金木水火土）在每个大运（如戊辰、己巳、庚午……）中的影响力。输出格式应为以下 JSON 结构，其中 `da_yun`（对应大运）、`value` 和 `type` 需根据用户输入的“大运”、“调候喜忌”及“大运喜忌”动态生成：
    - **dayun**: 用户的大运，如戊辰、己巳、庚午 等
    - **value**: 影响力分数，范围 -40 到 40
    - **type**: 喜或忌，基于喜用神和大运分析

    #### 输出格式示例：
    {
    "金": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"}
    ],
    "木": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"}
    ],
    "水": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"}
    ],
    "火": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"}
    ],
    "土": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"}
    ]
    }
    """

    systemPrompt = """
    你是一位专业的八字分析师。请基于给定的八字信息进行分析，直接给出洞察和建议。
    避免重复原始数据，专注于提供有价值的解读和建议。
    使用通俗易懂的语言，确保分析结果清晰、简洁且富有洞察力。
    """
    print(prompt)
    print()
    print(systemPrompt)
    print('-'*100)
    interpreted_result = glm4_model.chat(prompt,systemPrompt)
    return interpreted_result



## 喜忌分析
def bazi_xiji_ai_analysis_stream(result):

    prompt1 = f"""
    基于以下八字信息进行分析：
    {json.dumps(result, ensure_ascii=False)}
    """

    prompt = prompt1 + """
    你是一位资深的八字命理专家
    请你基于这些信息，进行详细的五行喜忌分析，并按以下步骤生成内容：

    ### 一、五行喜忌分析
    1. **喜用神和忌用神**：根据用户八字，指出最重要的喜用神和忌用神，并解释这些神在八字中的作用。
    2. **流年影响**：分析未来三年内流年对用户喜用神的影响，重点描述运势的起伏变化。
    3. **幸运颜色和方位**：根据用户八字中的喜用神，提供适合用户的幸运颜色和方位，并说明如何利用这些元素提升运势。

    ### 二、五行影响力评分
    根据用户的八字、大运喜忌及调候喜忌，分析五行（金木水火土）在每个大运（如戊辰、己巳、庚午……）中的影响力。输出格式应为以下 JSON 结构，其中 `da_yun`（对应大运）、`value` 和 `type` 需根据用户输入的“大运”、“调候喜忌”及“大运喜忌”动态生成：
    - **dayun**: 用户的大运，如戊辰、己巳、庚午 等
    - **value**: 影响力分数，范围 -40 到 40
    - **type**: 喜或忌，基于喜用神和大运分析

    #### 输出格式示例：
    {
    "金": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的金五行得分", "type": "模型基于分析的类型"}
    ],
    "木": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的木五行得分", "type": "模型基于分析的类型"}
    ],
    "水": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的水五行得分", "type": "模型基于分析的类型"}
    ],
    "火": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的火五行得分", "type": "模型基于分析的类型"}
    ],
    "土": [
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"},
        {"da_yun": "基于用户输入的大运", "value": "模型基于大运和调候分析的土五行得分", "type": "模型基于分析的类型"}
    ]
    }
    """

    systemPrompt = """
    你是一位专业的八字分析师。请基于给定的八字信息进行分析，直接给出洞察和建议。
    避免重复原始数据，专注于提供有价值的解读和建议。
    使用通俗易懂的语言，确保分析结果清晰、简洁且富有洞察力。
    """
    print(prompt)
    print()
    print(systemPrompt)
    print('-'*100)
    for chunk in glm4_model.stream_chat(prompt, systemPrompt):
        yield chunk
